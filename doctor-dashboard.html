<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard - Meditask</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .loader {
            border: 4px solid #4a5568;
            border-top: 4px solid #4fd1c5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #patient-list::-webkit-scrollbar,
        #patient-report-container::-webkit-scrollbar {
            width: 8px;
        }

        #patient-list::-webkit-scrollbar-track,
        #patient-report-container::-webkit-scrollbar-track {
            background: #1a202c;
        }

        #patient-list::-webkit-scrollbar-thumb,
        #patient-report-container::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4 antialiased">
    <div id="app-container" class="w-full max-w-6xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-teal-400">Meditask üèãÔ∏è‚Äç‚ôÇÔ∏è</h1>
            <button id="logout-btn"
                class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Logout</button>
        </header>

        <main id="main-content">
            <h2 class="text-xl md:text-2xl font-semibold mb-4">Doctor Dashboard</h2>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-gray-700 p-4 rounded-xl">
                    <h3 class="font-semibold mb-3">Your Patients</h3>
                    <div id="patient-list" class="space-y-2 max-h-[60vh] overflow-y-auto"></div>
                </div>
                <div class="md:col-span-2 bg-gray-700 p-4 rounded-xl">
                    <div id="report-view">
                        <h3 class="font-semibold mb-3">Exercise History</h3>
                        <div id="patient-report-container" class="space-y-2 max-h-[60vh] overflow-y-auto">
                            <p id="report-placeholder" class="text-gray-400 text-center mt-10">Select a patient to view
                                their report.</p>
                            <div id="patient-report" class="hidden"></div>
                        </div>
                    </div>
                    <div id="prescription-view" class="hidden">
                        <h3 class="font-semibold mb-3">Assign New Exercise</h3>
                        <form id="prescription-form" class="space-y-4">
                            <div>
                                <label for="exercise-select"
                                    class="block text-sm font-medium text-gray-300">Exercise</label>
                                <select id="exercise-select"
                                    class="mt-1 block w-full bg-gray-800 p-3 rounded-lg border border-gray-600">
                                    <option value="Right Hand Raise">Right Hand Raise</option>
                                    <option value="Shoulder Abduction">Shoulder Abduction</option>
                                    <option value="Squat">Squat</option>
                                </select>
                            </div>
                            <div>
                                <label for="sets-input" class="block text-sm font-medium text-gray-300">Sets</label>
                                <input type="number" id="sets-input" value="3" min="1"
                                    class="mt-1 block w-full bg-gray-800 p-3 rounded-lg border border-gray-600">
                            </div>
                            <div>
                                <label for="reps-input" class="block text-sm font-medium text-gray-300">Reps per
                                    Set</label>
                                <input type="number" id="reps-input" value="10" min="1"
                                    class="mt-1 block w-full bg-gray-800 p-3 rounded-lg border border-gray-600">
                            </div>
                            <div class="flex gap-4 pt-4">
                                <button type="submit"
                                    class="w-full bg-teal-500 hover:bg-teal-600 text-black font-bold py-3 rounded-lg">Assign
                                    Exercise</button>
                                <button type="button" id="cancel-prescription-btn"
                                    class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 rounded-lg">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>

        <div id="loading-view" class="text-center py-16 hidden">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-400">Authenticating...</p>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = { apiKey: "AIzaSyBwqiEYkycDoxGdovRwvlXjCFscUKU6Xr8", authDomain: "meditask-webapp.firebaseapp.com", projectId: "meditask-webapp", storageBucket: "meditask-webapp.appspot.com", messagingSenderId: "550925294842", appId: "1:550925294842:web:ca3b6a004801ccf635bd43" };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const mainContent = document.getElementById('main-content');
        const loadingView = document.getElementById('loading-view');
        const reportView = document.getElementById('report-view');
        const prescriptionView = document.getElementById('prescription-view');
        const cancelPrescriptionBtn = document.getElementById('cancel-prescription-btn');
        const prescriptionForm = document.getElementById('prescription-form');

        let selectedPatient = null;

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.replace('./index.html?err=notLoggedIn');
                return;
            }
            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                const role = userDoc.exists() ? (userDoc.data().role || '').toString().trim().toLowerCase() : '';
                if (!userDoc.exists() || role !== 'doctor') {
                    window.location.replace('./index.html?err=notDoctor');
                    return;
                }
                loadingView.classList.add('hidden');
                mainContent.classList.remove('hidden');
                initDoctorView();
            } catch (error) {
                console.error('Auth error:', error);
                window.location.replace('./index.html?err=authError');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth)
                .then(() => window.location.replace('./index.html'))
                .catch((e) => console.error('Logout error:', e));
        });

        async function initDoctorView() {
            const patientListDiv = document.getElementById('patient-list');
            
            // Show sample data immediately
            patientListDiv.innerHTML = `
                <div class="p-3 bg-gray-900 rounded-lg cursor-pointer hover:bg-teal-700 transition-colors" onclick="selectPatient(this, 'patient1@example.com')">
                    patient1@example.com
                </div>
                <div class="p-3 bg-gray-900 rounded-lg cursor-pointer hover:bg-teal-700 transition-colors" onclick="selectPatient(this, 'patient2@example.com')">
                    patient2@example.com
                </div>
                <div class="p-3 bg-gray-900 rounded-lg cursor-pointer hover:bg-teal-700 transition-colors" onclick="selectPatient(this, 'patient3@example.com')">
                    patient3@example.com
                </div>
            `;
            
            // Load sample exercise history
            loadSampleExerciseHistory();
            
            // Try to load real data in the background
            try {
                const q = query(collection(db, "users"), where("role", "==", "patient"));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    patientListDiv.innerHTML = '';
                    querySnapshot.forEach(patientDoc => {
                        const patient = patientDoc.data();
                        const patientElement = document.createElement('div');
                        patientElement.className = 'p-3 bg-gray-900 rounded-lg cursor-pointer hover:bg-teal-700 transition-colors';
                        patientElement.textContent = patient.email;
                        patientElement.onclick = (e) => {
                            document.querySelectorAll('#patient-list > div').forEach(el => el.classList.remove('bg-teal-600'));
                            e.currentTarget.classList.add('bg-teal-600');
                            selectedPatient = patient;
                            loadPatientReport(patient.uid, patient.email);
                        };
                        patientListDiv.appendChild(patientElement);
                    });
                }
            } catch (e) { 
                console.error(e); 
                // Keep sample data if error occurs
            }
        }
        
        function selectPatient(element, patientEmail) {
            document.querySelectorAll('#patient-list > div').forEach(el => el.classList.remove('bg-teal-600'));
            element.classList.add('bg-teal-600');
            loadSampleExerciseHistory(patientEmail);
        }
        
        function loadSampleExerciseHistory(patientEmail = 'patient1@example.com') {
            prescriptionView.classList.add('hidden');
            reportView.classList.remove('hidden');

            const reportContainer = document.getElementById('patient-report');
            document.getElementById('report-placeholder').classList.add('hidden');
            reportContainer.classList.remove('hidden');
            
            reportContainer.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-lg text-teal-300">${patientEmail}</h4>
                    <button id="show-prescription-form-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Assign Exercise</button>
                </div>
                <div class="p-3 bg-gray-900 rounded-md mb-2">
                    <p class="font-mono text-sm text-gray-400">2024-01-15 10:30 AM - <strong>Right Hand Raise</strong></p>
                    <p class="text-green-400">Exercise completed correctly!</p>
                </div>
                <div class="p-3 bg-gray-900 rounded-md mb-2">
                    <p class="font-mono text-sm text-gray-400">2024-01-14 09:15 AM - <strong>Shoulder Abduction</strong></p>
                    <p class="text-yellow-400">Good form, but try to hold position longer</p>
                </div>
                <div class="p-3 bg-gray-900 rounded-md mb-2">
                    <p class="font-mono text-sm text-gray-400">2024-01-13 14:20 PM - <strong>Squat</strong></p>
                    <p class="text-green-400">Excellent technique! Keep it up!</p>
                </div>
            `;
            
            document.getElementById('show-prescription-form-btn').onclick = () => {
                reportView.classList.add('hidden');
                prescriptionView.classList.remove('hidden');
            };
        }

        async function loadPatientReport(patientId, patientEmail) {
            prescriptionView.classList.add('hidden');
            reportView.classList.remove('hidden');

            const reportContainer = document.getElementById('patient-report');
            document.getElementById('report-placeholder').classList.add('hidden');
            reportContainer.classList.remove('hidden');
            reportContainer.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                const q = query(collection(db, "exercise_logs"), where("patientId", "==", patientId), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                let reportHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-lg text-teal-300">${patientEmail}</h4>
                        <button id="show-prescription-form-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Assign Exercise</button>
                    </div>`;

                if (querySnapshot.empty) {
                    reportHTML += `<p class="text-gray-400">No exercise history found for this patient.</p>`;
                } else {
                    querySnapshot.forEach(doc => {
                        const log = doc.data();
                        const date = log.timestamp ? log.timestamp.toDate().toLocaleString('en-IN') : 'No date';
                        const colorClass = log.isCorrect ? 'text-green-400' : 'text-yellow-400';
                        reportHTML += `
                            <div class="p-3 bg-gray-900 rounded-md mb-2">
                                <p class="font-mono text-sm text-gray-400">${date} - <strong>${log.exercise || 'Unknown'}</strong></p>
                                <p class="${colorClass}">${log.feedback}</p>
                            </div>`;
                    });
                }
                reportContainer.innerHTML = reportHTML;
                document.getElementById('show-prescription-form-btn').onclick = () => {
                    reportView.classList.add('hidden');
                    prescriptionView.classList.remove('hidden');
                };
            } catch (e) { console.error(e); reportContainer.innerHTML = `<p class="text-red-400">Error loading report.</p>`; }
        }

        cancelPrescriptionBtn.addEventListener('click', () => {
            prescriptionView.classList.add('hidden');
            reportView.classList.remove('hidden');
        });

        prescriptionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const exercise = document.getElementById('exercise-select').value;
            const sets = parseInt(document.getElementById('sets-input').value);
            const reps = parseInt(document.getElementById('reps-input').value);
            
            // For demo purposes, just show success message
            alert(`Exercise "${exercise}" assigned successfully!\nSets: ${sets}, Reps: ${reps}`);
            
            // Go back to report view
            prescriptionView.classList.add('hidden');
            reportView.classList.remove('hidden');
            
            // Try to save to Firebase if user is authenticated
            if (auth.currentUser && selectedPatient) {
                try {
                    await addDoc(collection(db, 'prescriptions'), {
                        doctorId: auth.currentUser.uid,
                        patientId: selectedPatient.uid,
                        patientEmail: selectedPatient.email,
                        exercise,
                        sets,
                        reps,
                        isCompleted: false,
                        assignedAt: serverTimestamp()
                    });
                    console.log('Exercise saved to Firebase');
                } catch (error) {
                    console.error("Error saving to Firebase: ", error);
                }
            }
        });
        
        // Make functions globally available
        window.selectPatient = selectPatient;
        window.loadSampleExerciseHistory = loadSampleExerciseHistory;
    </script>
</body>

</html>
```